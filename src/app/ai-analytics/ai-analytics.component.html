<div class="ai-analytics-dashboard">
  <!-- Header -->
  <div class="dashboard-header d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="fas fa-brain text-primary"></i> AI Analytics Dashboard</h2>
      <p class="text-muted">Advanced insights powered by artificial intelligence</p>
    </div>
    <div class="dashboard-actions">
      <button class="btn btn-outline-secondary me-2" (click)="navigateBackToDashboard()">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
      <button class="btn btn-outline-primary me-2" (click)="refreshDashboard()">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
      <div class="dropdown d-inline-block">
        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-download"></i> Export
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" (click)="exportData('pdf')">Export as PDF</a></li>
          <li><a class="dropdown-item" (click)="exportData('excel')">Export as Excel</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Breadcrumb Navigation -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="#" (click)="navigateBackToDashboard()" class="text-decoration-none">
          <i class="fas fa-home"></i> Dashboard
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        <i class="fas fa-brain"></i> AI Analytics
      </li>
    </ol>
  </nav>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="selectedTab === 'dashboard'" 
         (click)="selectTab('dashboard')">
        <i class="fas fa-chart-line"></i> Overview
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="selectedTab === 'predictions'" 
         (click)="selectTab('predictions')">
        <i class="fas fa-crystal-ball"></i> Predictions
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="selectedTab === 'anomalies'" 
         (click)="selectTab('anomalies')">
        <i class="fas fa-exclamation-triangle"></i> Anomalies
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="selectedTab === 'insights'" 
         (click)="selectTab('insights')">
        <i class="fas fa-lightbulb"></i> Insights
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="selectedTab === 'quality'" 
         (click)="selectTab('quality')">
        <i class="fas fa-check-circle"></i> Data Quality
      </a>
    </li>
  </ul>

  <!-- Dashboard Overview Tab -->
  <div *ngIf="selectedTab === 'dashboard'" class="tab-content">
    <div *ngIf="loading.dashboard" class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    
    <div *ngIf="dashboardData && !loading.dashboard">
      <!-- Key Metrics Row -->
      <div class="row mb-4">
        <div class="col-md-3" *ngFor="let prediction of dashboardData.keyPredictions.slice(0, 4)">
          <div class="card metric-card">
            <div class="card-body">
              <h6 class="card-title">{{prediction.departmentName}}</h6>
              <h3 class="text-primary">{{prediction.predictedEfficiency | number:'1.1-1'}}%</h3>
              <div class="d-flex align-items-center">
                <i class="fas fa-chart-line" [ngClass]="getRiskClass(prediction.riskScore)"></i>
                <span class="ms-1 small" [ngClass]="getRiskClass(prediction.riskScore)">
                  Risk: {{getRiskLevel(prediction.riskScore)}}
                </span>
              </div>
              <div class="progress mt-2" style="height: 4px;">
                <div class="progress-bar" 
                     [style.width.%]="(1 - prediction.riskScore) * 100"
                     [ngClass]="prediction.riskScore < 0.3 ? 'bg-success' : 
                               prediction.riskScore < 0.7 ? 'bg-warning' : 'bg-danger'">
                </div>
              </div>
              <small class="text-muted">Budget Forecast: {{prediction.budgetUtilizationForecast | number:'1.0-0'}}%</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Anomalies & Recommendations Row -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-exclamation-triangle text-warning"></i> Recent Anomalies</h5>
            </div>
            <div class="card-body">
              <div *ngIf="dashboardData.recentAnomalies.length === 0" class="text-center text-muted">
                <i class="fas fa-check-circle text-success fa-2x"></i>
                <p class="mt-2">No anomalies detected</p>
              </div>
              <div *ngFor="let anomaly of dashboardData.recentAnomalies.slice(0, 3)" 
                   class="anomaly-item border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between">
                  <strong>{{anomaly.affectedMetric}}</strong>
                  <span class="badge" [ngClass]="getSeverityClass(anomaly.severity)">
                    {{anomaly.severity}}
                  </span>
                </div>
                <p class="text-muted small mb-1">Deviation: {{anomaly.deviation | number:'1.1-2'}}</p>
                <p class="small mb-0">{{anomaly.possibleCauses[0]}}</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-lightbulb text-info"></i> AI Recommendations</h5>
            </div>
            <div class="card-body">
              <div *ngFor="let recommendation of dashboardData.aiRecommendations.slice(0, 3)" 
                   class="recommendation-item border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between">
                  <strong class="small">{{recommendation.title}}</strong>
                  <span class="badge badge-sm" [ngClass]="getSeverityClass(recommendation.priority)">
                    {{recommendation.priority}}
                  </span>
                </div>
                <p class="small text-muted mb-1">{{recommendation.description}}</p>
                <div class="small">
                  <i class="fas fa-chart-line"></i> 
                  Impact: {{recommendation.expectedImpact}} | 
                  Confidence: {{recommendation.confidenceScore * 100 | number:'1.0-0'}}%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Quality Score -->
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-chart-pie"></i> System Health Overview</h5>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-md-3" *ngFor="let quality of dashboardData.dataQualityScores | keyvalue">
                  <h4 [ngClass]="getQualityScoreClass(quality.value)">
                    {{quality.value * 100 | number:'1.1-1'}}%
                  </h4>
                  <p class="text-muted">{{quality.key | titlecase}} Quality</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Predictions Tab -->
  <div *ngIf="selectedTab === 'predictions'" class="tab-content">
    <div class="row mb-3">
      <div class="col-md-6">
        <select class="form-select" [(ngModel)]="selectedDepartment" (change)="onDepartmentChange()">
          <option value="all">All Departments</option>
          <option value="Sales">Sales</option>
          <option value="Marketing">Marketing</option>
          <option value="Operations">Operations</option>
          <option value="HR">Human Resources</option>
          <option value="Finance">Finance</option>
        </select>
      </div>
      <div class="col-md-6">
        <select class="form-select" [(ngModel)]="selectedTimeframe" (change)="onTimeframeChange()">
          <option value="7">7 Days</option>
          <option value="30">30 Days</option>
          <option value="90">90 Days</option>
          <option value="180">6 Months</option>
          <option value="365">1 Year</option>
        </select>
      </div>
    </div>

    <div *ngIf="loading.predictions" class="text-center">
      <div class="spinner-border" role="status"></div>
    </div>

    <div *ngIf="predictions.length > 0 && !loading.predictions" class="row">
      <div class="col-md-4" *ngFor="let prediction of predictions">
        <div class="card mb-3">
          <div class="card-body">
            <h6 class="card-title">{{prediction.algorithm}} Prediction</h6>
            <h3 class="text-primary">{{prediction.predictedValue | number:'1.2-2'}}</h3>
            <p class="text-muted small">Confidence: {{prediction.confidenceLevel * 100}}%</p>
            <p class="small">Trend: {{prediction.trendDirection}}</p>
            <div class="risk-indicator">
              <span class="badge" 
                    [ngClass]="prediction.riskScore > 0.7 ? 'bg-danger' : 
                               prediction.riskScore > 0.4 ? 'bg-warning' : 'bg-success'">
                Risk: {{prediction.riskScore * 100 | number:'1.0-0'}}%
              </span>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                Range: {{prediction.confidenceInterval.lower | number:'1.1-1'}} - 
                {{prediction.confidenceInterval.upper | number:'1.1-1'}}
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Anomalies Tab -->
  <div *ngIf="selectedTab === 'anomalies'" class="tab-content">
    <div class="row mb-3">
      <div class="col-md-12">
        <div class="btn-group" role="group">
          <button class="btn btn-outline-primary" (click)="detectAnomalies('efficiency')">
            Efficiency
          </button>
          <button class="btn btn-outline-primary" (click)="detectAnomalies('performance')">
            Performance
          </button>
          <button class="btn btn-outline-primary" (click)="detectAnomalies('budget')">
            Budget
          </button>
          <button class="btn btn-outline-primary" (click)="detectAnomalies('quality')">
            Quality
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="loading.anomalies" class="text-center">
      <div class="spinner-border" role="status"></div>
    </div>

    <div *ngIf="anomalies.length > 0 && !loading.anomalies">
      <div class="card" *ngFor="let anomaly of anomalies">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="card-title">{{anomaly.affectedMetric}} Anomaly</h6>
              <p class="text-muted">Detected: {{anomaly.timestamp | date:'short'}}</p>
            </div>
            <span class="badge" [ngClass]="getSeverityClass(anomaly.severity)">
              {{anomaly.severity}}
            </span>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <p><strong>Actual Value:</strong> {{anomaly.dataPoint | number:'1.2-2'}}</p>
              <p><strong>Expected Value:</strong> {{anomaly.expectedValue | number:'1.2-2'}}</p>
              <p><strong>Deviation:</strong> {{anomaly.deviation | number:'1.2-2'}}</p>
              <p><strong>Detection Method:</strong> {{anomaly.detectionMethod}}</p>
            </div>
            <div class="col-md-6">
              <div *ngIf="anomaly.possibleCauses.length > 0">
                <strong>Possible Causes:</strong>
                <ul class="small">
                  <li *ngFor="let cause of anomaly.possibleCauses">{{cause}}</li>
                </ul>
              </div>
              <div *ngIf="anomaly.recommendedActions.length > 0">
                <strong>Recommended Actions:</strong>
                <ul class="small">
                  <li *ngFor="let action of anomaly.recommendedActions">{{action}}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Insights Tab -->
  <div *ngIf="selectedTab === 'insights'" class="tab-content">
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-users"></i> Department Clusters</h5>
          </div>
          <div class="card-body">
            <div *ngFor="let cluster of departmentClusters" class="cluster-item mb-3">
              <h6>{{cluster.clusterName}}</h6>
              <p class="small">Performance Level: 
                <span [ngClass]="getPerformanceLevelClass(cluster.performanceLevel)">
                  {{cluster.performanceLevel}}
                </span>
              </p>
              <div class="departments mb-2">
                <span class="badge bg-primary me-1" *ngFor="let dept of cluster.departments">
                  {{dept}}
                </span>
              </div>
              <div class="common-traits">
                <strong>Common Traits:</strong>
                <ul class="small">
                  <li *ngFor="let trait of cluster.commonTraits">{{trait}}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-magic"></i> AI Recommendations</h5>
          </div>
          <div class="card-body">
            <div *ngFor="let recommendation of recommendations" class="recommendation-detail mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">{{recommendation.title}}</h6>
                <span class="badge" [ngClass]="getSeverityClass(recommendation.priority)">
                  {{recommendation.priority}}
                </span>
              </div>
              <p class="text-muted small">{{recommendation.description}}</p>
              <p class="small"><strong>Department:</strong> {{recommendation.department}}</p>
              <p class="small"><strong>Expected Impact:</strong> {{recommendation.expectedImpact}}</p>
              
              <div *ngIf="recommendation.actionItems.length > 0">
                <strong class="small">Action Items:</strong>
                <ul class="small">
                  <li *ngFor="let action of recommendation.actionItems">{{action}}</li>
                </ul>
              </div>
              
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">
                  Confidence: {{recommendation.confidenceScore * 100 | number:'1.0-0'}}%
                </small>
                <small class="text-muted">
                  {{recommendation.generatedAt | date:'short'}}
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Quality Tab -->
  <div *ngIf="selectedTab === 'quality'" class="tab-content">
    <div *ngIf="dataQuality" class="card">
      <div class="card-header">
        <h5><i class="fas fa-check-circle"></i> Data Quality Assessment</h5>
      </div>
      <div class="card-body">
        <div class="row text-center mb-4">
          <div class="col-md-3">
            <h3 [ngClass]="getQualityScoreClass(dataQuality.overallQualityScore)">
              {{dataQuality.overallQualityScore * 100 | number:'1.1-1'}}%
            </h3>
            <p class="text-muted">Overall Score</p>
          </div>
          <div class="col-md-3">
            <h4 [ngClass]="getQualityScoreClass(dataQuality.qualityMetrics.completeness)">
              {{dataQuality.qualityMetrics.completeness * 100 | number:'1.1-1'}}%
            </h4>
            <p class="text-muted">Completeness</p>
          </div>
          <div class="col-md-3">
            <h4 [ngClass]="getQualityScoreClass(dataQuality.qualityMetrics.accuracy)">
              {{dataQuality.qualityMetrics.accuracy * 100 | number:'1.1-1'}}%
            </h4>
            <p class="text-muted">Accuracy</p>
          </div>
          <div class="col-md-3">
            <h4 [ngClass]="getQualityScoreClass(dataQuality.qualityMetrics.consistency)">
              {{dataQuality.qualityMetrics.consistency * 100 | number:'1.1-1'}}%
            </h4>
            <p class="text-muted">Consistency</p>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <h6>Issues Found:</h6>
            <div *ngIf="dataQuality.issuesFound.length === 0" class="text-success">
              <i class="fas fa-check-circle"></i> No issues detected
            </div>
            <ul *ngIf="dataQuality.issuesFound.length > 0">
              <li *ngFor="let issue of dataQuality.issuesFound" class="text-warning">
                {{issue}}
              </li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6>Improvement Suggestions:</h6>
            <ul *ngIf="dataQuality.improvementSuggestions.length > 0">
              <li *ngFor="let suggestion of dataQuality.improvementSuggestions">
                {{suggestion}}
              </li>
            </ul>
            <div *ngIf="dataQuality.improvementSuggestions.length === 0" class="text-muted">
              No specific improvements needed at this time.
            </div>
          </div>
        </div>

        <div class="mt-3">
          <small class="text-muted">
            Last assessed: {{dataQuality.assessedAt | date:'medium'}}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Messages -->
  <div *ngFor="let error of errors | keyvalue" class="alert alert-danger mt-3">
    <strong>Error:</strong> {{error.value}}
  </div>
</div>
